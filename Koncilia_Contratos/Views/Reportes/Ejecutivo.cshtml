@{
    ViewData["Title"] = "Reporte Ejecutivo";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="display-4">@ViewData["Title"]</h1>
            <p class="lead">Resumen ejecutivo de la gestión de contratos</p>
            <hr />
        </div>
    </div>

    <!-- Sección de KPIs principales -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h3 class="mb-3">Indicadores Clave de Desempeño (KPIs)</h3>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6 class="card-title">Total Contratos</h6>
                    <h2 class="card-text">@ViewBag.TotalContratos</h2>
                    <small>Este año: @ViewBag.ContratosAnioActual</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6 class="card-title">Contratos Activos</h6>
                    <h2 class="card-text">@ViewBag.ContratosActivos</h2>
                    <small>En ejecución</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h6 class="card-title">Valor Total Cartera</h6>
                    <h3 class="card-text">@(((decimal)ViewBag.ValorTotalCartera).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h3>
                    <small>Todos los contratos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6 class="card-title">Cartera Activa</h6>
                    <h3 class="card-text">@(((decimal)ViewBag.ValorCarteraActiva).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h3>
                    <small>En ejecución</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de ejecución financiera -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Facturado</h5>
                </div>
                <div class="card-body text-center">
                    <h2 class="text-success">@(((decimal)ViewBag.ValorTotalFacturado).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h2>
                    <p class="mb-0">Total ejecutado</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Pendiente</h5>
                </div>
                <div class="card-body text-center">
                    <h2 class="text-secondary">@(((decimal)ViewBag.ValorTotalPendiente).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h2>
                    <p class="mb-0">Por ejecutar</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header text-white" style="background-color: #6f42c1;">
                    <h5 class="mb-0">% Ejecución</h5>
                </div>
                <div class="card-body text-center">
                    <h2 style="color: #6f42c1;">@(((decimal)ViewBag.PromedioEjecucionGeneral).ToString("F2"))%</h2>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar" style="width: @(ViewBag.PromedioEjecucionGeneral)%; background-color: #6f42c1;">
                            Promedio General
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas y notificaciones -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h3 class="mb-3">Alertas</h3>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Contratos por Vencer</h4>
                <p class="mb-0">Hay <strong>@ViewBag.ContratosPorVencer</strong> contrato(s) que vencen en los próximos 30 días.</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-danger" role="alert">
                <h4 class="alert-heading"><i class="bi bi-x-circle"></i> Contratos Vencidos</h4>
                <p class="mb-0">Hay <strong>@ViewBag.ContratosVencidos</strong> contrato(s) vencido(s) que requieren atención inmediata.</p>
            </div>
        </div>
    </div>

    <!-- Distribución por estado -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Distribución por Estado</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Estado</th>
                                    <th>Cantidad</th>
                                    <th>Valor Total</th>
                                    <th>Distribución</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in ViewBag.DistribucionEstado)
                                {
                                    var porcentaje = (item.Cantidad * 100.0) / ViewBag.TotalContratos;
                                    <tr>
                                        <td><strong>@item.Estado</strong></td>
                                        <td>@item.Cantidad</td>
                                        <td>@(((decimal)item.Valor).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</td>
                                        <td>
                                            <div class="progress" style="min-width: 200px;">
                                                <div class="progress-bar @(item.Estado == "Activo" ? "bg-success" : item.Estado == "Finalizado" ? "bg-secondary" : item.Estado == "Suspendido" ? "bg-warning" : "bg-danger")" 
                                                     role="progressbar" 
                                                     style="width: @porcentaje%" 
                                                     aria-valuenow="@porcentaje" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    @porcentaje.ToString("F1")%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evolución anual -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Evolución Anual</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartEvolucion"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <a asp-action="Index" class="btn btn-secondary btn-lg">
                <i class="bi bi-arrow-left"></i> Volver a Reportes
            </a>
            <button onclick="window.print()" class="btn btn-primary btn-lg">
                <i class="bi bi-printer"></i> Imprimir Reporte
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script>
        @{
            var evolucionLabels = string.Join(",", ((IEnumerable<dynamic>)ViewBag.EvolucionAnual).Select(x => $"'{x.Anio}'"));
            var evolucionCantidades = string.Join(",", ((IEnumerable<dynamic>)ViewBag.EvolucionAnual).Select(x => x.Cantidad.ToString()));
            var evolucionValores = string.Join(",", ((IEnumerable<dynamic>)ViewBag.EvolucionAnual).Select(x => Math.Round(x.Valor / 1000000.0, 2).ToString()));
            var evolucionFacturados = string.Join(",", ((IEnumerable<dynamic>)ViewBag.EvolucionAnual).Select(x => Math.Round(x.Facturado / 1000000.0, 2).ToString()));
        }
        
        // Gráfica de Evolución Anual
        const ctxEvolucion = document.getElementById('chartEvolucion').getContext('2d');
        new Chart(ctxEvolucion, {
            type: 'line',
            data: {
                labels: [@Html.Raw(evolucionLabels)],
                datasets: [{
                    label: 'Cantidad de Contratos',
                    data: [@Html.Raw(evolucionCantidades)],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: 'Valor Total (Millones COP)',
                    data: [@Html.Raw(evolucionValores)],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }, {
                    label: 'Facturado (Millones COP)',
                    data: [@Html.Raw(evolucionFacturados)],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Cantidad de Contratos'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Valor (Millones COP)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    </script>

    <style>
        @@media print {
            .btn, nav, footer { display: none; }
        }
    </style>
}

