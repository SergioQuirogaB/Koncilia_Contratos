@{
    ViewData["Title"] = "Reportes y Análisis";
}

<!-- Header -->
<div class="mb-6">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center mb-2">
        <span class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-2 rounded-lg mr-3">
            <i class="fas fa-chart-bar"></i>
        </span>
        Reportes y Análisis
    </h1>
    <p class="text-sm text-gray-600">Visualiza las estadísticas y métricas de tus contratos</p>
</div>

<!-- Tarjetas de resumen principales -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
    <!-- Total Contratos -->
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg overflow-hidden">
        <div class="p-5 text-white">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold uppercase tracking-wider opacity-90">Total Contratos</h5>
                <i class="fas fa-file-contract text-2xl opacity-75"></i>
            </div>
            <h2 class="text-4xl font-bold mb-1">@ViewBag.TotalContratos</h2>
            <p class="text-xs opacity-75">@ViewBag.ContratosActivos activos</p>
        </div>
    </div>
    
    <!-- Valor Total -->
    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg overflow-hidden">
        <div class="p-5 text-white">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold uppercase tracking-wider opacity-90">Valor Total</h5>
                <i class="fas fa-dollar-sign text-2xl opacity-75"></i>
            </div>
            <h2 class="text-3xl font-bold mb-1">@(((decimal)ViewBag.ValorTotalPesos).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h2>
            <p class="text-xs opacity-75">En todos los contratos</p>
        </div>
    </div>
    
    <!-- Por Vencer -->
    <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl shadow-lg overflow-hidden">
        <div class="p-5 text-white">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold uppercase tracking-wider opacity-90">Por Vencer</h5>
                <i class="fas fa-clock text-2xl opacity-75"></i>
            </div>
            <h2 class="text-4xl font-bold mb-1">@ViewBag.ContratosPorVencer</h2>
            <p class="text-xs opacity-75">En los próximos 30 días</p>
        </div>
    </div>
    
    <!-- Vencidos -->
    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg overflow-hidden">
        <div class="p-5 text-white">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold uppercase tracking-wider opacity-90">Vencidos</h5>
                <i class="fas fa-exclamation-triangle text-2xl opacity-75"></i>
            </div>
            <h2 class="text-4xl font-bold mb-1">@ViewBag.ContratosVencidos</h2>
            <p class="text-xs opacity-75">Requieren atención</p>
        </div>
    </div>
</div>

<!-- Tarjetas financieras -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-6">
    <!-- Facturado -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-5 border-l-4 border-cyan-500">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Facturado</h5>
                <i class="fas fa-check-circle text-cyan-500 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-cyan-600 mb-1">@(((decimal)ViewBag.ValorTotalFacturado).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h2>
            <p class="text-xs text-gray-500">Total ejecutado</p>
        </div>
    </div>
    
    <!-- Pendiente -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-5 border-l-4 border-gray-500">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Pendiente</h5>
                <i class="fas fa-hourglass-half text-gray-500 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-600 mb-1">@(((decimal)ViewBag.ValorTotalPendiente).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h2>
            <p class="text-xs text-gray-500">Por ejecutar</p>
        </div>
    </div>
    
    <!-- % Ejecución -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-5 border-l-4 border-purple-500">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">% Ejecución</h5>
                <i class="fas fa-percentage text-purple-500 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-purple-600 mb-1">@(((decimal)ViewBag.PromedioEjecucion).ToString("F2"))%</h2>
            <p class="text-xs text-gray-500">Promedio general</p>
        </div>
    </div>
</div>

<!-- Gráficas -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Contratos por Estado -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-blue-500 to-blue-600 border-b border-blue-700">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-chart-pie mr-2"></i>
                Contratos por Estado
            </h3>
        </div>
        <div class="p-6">
            <canvas id="chartEstados" class="max-h-64"></canvas>
        </div>
    </div>
    
    <!-- Contratos por Categoría -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-green-500 to-emerald-600 border-b border-green-700">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-chart-pie mr-2"></i>
                Contratos por Categoría
            </h3>
        </div>
        <div class="p-6">
            <canvas id="chartCategorias" class="max-h-64"></canvas>
        </div>
    </div>
</div>

<!-- Evolución por año -->
<div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
    <div class="px-5 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 border-b border-purple-700">
        <h3 class="text-lg font-semibold text-white flex items-center">
            <i class="fas fa-chart-line mr-2"></i>
            Evolución de Contratos por Año
        </h3>
    </div>
    <div class="p-6">
        <canvas id="chartAnios"></canvas>
    </div>
</div>

<!-- Top 10 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Top Empresas -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 border-b border-yellow-700">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-building mr-2"></i>
                Top 10 Empresas por Valor
            </h3>
        </div>
        <div class="p-6">
            <canvas id="chartEmpresas"></canvas>
        </div>
    </div>
    
    <!-- Top Clientes -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-red-500 to-red-600 border-b border-red-700">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-users mr-2"></i>
                Top 10 Clientes por Valor
            </h3>
        </div>
        <div class="p-6">
            <canvas id="chartClientes"></canvas>
        </div>
    </div>
</div>

<!-- Botones de reportes específicos -->
<div class="flex flex-col sm:flex-row gap-4 justify-center">
    <a asp-action="Clientes" 
       class="inline-flex items-center justify-center px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition">
        <i class="fas fa-users text-2xl mr-3"></i>
        <div class="text-left">
            <div class="text-sm opacity-90">Ver Reporte de</div>
            <div class="text-lg">Clientes</div>
        </div>
    </a>
    <a asp-action="Ejecutivo" 
       class="inline-flex items-center justify-center px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition">
        <i class="fas fa-chart-line text-2xl mr-3"></i>
        <div class="text-left">
            <div class="text-sm opacity-90">Ver Reporte</div>
            <div class="text-lg">Ejecutivo</div>
        </div>
    </a>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        @{
            var estadosLabels = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorEstado).Select(x => $"'{x.Estado}'"));
            var estadosCantidades = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorEstado).Select(x => x.Cantidad.ToString()));
            
            var categoriasLabels = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorCategoria).Select(x => $"'{x.Categoria}'"));
            var categoriasCantidades = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorCategoria).Select(x => x.Cantidad.ToString()));
            
            var aniosLabels = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorAnio).Select(x => $"'{x.Anio}'"));
            var aniosCantidades = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorAnio).Select(x => x.Cantidad.ToString()));
            var aniosValores = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorAnio).Select(x => Math.Round(x.Valor / 1000000.0, 2).ToString()));
            
            var empresasLabels = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorEmpresa).Select(x => $"'{x.Empresa}'"));
            var empresasValores = string.Join(",", ((IEnumerable<dynamic>)ViewBag.ContratosPorEmpresa).Select(x => Math.Round(x.Valor / 1000000.0, 2).ToString()));
            
            var clientesLabels = string.Join(",", ((IEnumerable<dynamic>)ViewBag.TopClientes).Select(x => $"'{x.Cliente}'"));
            var clientesValores = string.Join(",", ((IEnumerable<dynamic>)ViewBag.TopClientes).Select(x => Math.Round(x.Valor / 1000000.0, 2).ToString()));
        }
        
        // Gráfica de Estados
        const ctxEstados = document.getElementById('chartEstados').getContext('2d');
        new Chart(ctxEstados, {
            type: 'pie',
            data: {
                labels: [@Html.Raw(estadosLabels)],
                datasets: [{
                    data: [@Html.Raw(estadosCantidades)],
                    backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#6b7280']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Gráfica de Categorías
        const ctxCategorias = document.getElementById('chartCategorias').getContext('2d');
        new Chart(ctxCategorias, {
            type: 'doughnut',
            data: {
                labels: [@Html.Raw(categoriasLabels)],
                datasets: [{
                    data: [@Html.Raw(categoriasCantidades)],
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6', '#ec4899', '#f97316']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Gráfica de Años
        const ctxAnios = document.getElementById('chartAnios').getContext('2d');
        new Chart(ctxAnios, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(aniosLabels)],
                datasets: [{
                    label: 'Cantidad de Contratos',
                    data: [@Html.Raw(aniosCantidades)],
                    backgroundColor: '#3b82f6',
                    yAxisID: 'y'
                }, {
                    label: 'Valor (Millones COP)',
                    data: [@Html.Raw(aniosValores)],
                    backgroundColor: '#10b981',
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Cantidad'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Valor (Millones)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Gráfica de Empresas
        const ctxEmpresas = document.getElementById('chartEmpresas').getContext('2d');
        new Chart(ctxEmpresas, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(empresasLabels)],
                datasets: [{
                    label: 'Valor (Millones COP)',
                    data: [@Html.Raw(empresasValores)],
                    backgroundColor: '#f59e0b'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Gráfica de Clientes
        const ctxClientes = document.getElementById('chartClientes').getContext('2d');
        new Chart(ctxClientes, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(clientesLabels)],
                datasets: [{
                    label: 'Valor (Millones COP)',
                    data: [@Html.Raw(clientesValores)],
                    backgroundColor: '#ef4444'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    </script>
}
