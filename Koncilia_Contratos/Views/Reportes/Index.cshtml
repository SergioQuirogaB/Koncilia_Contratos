@{
    ViewData["Title"] = "Reportes y Análisis";
}

<!-- Header -->
<div class="mb-6">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center mb-2">
        <span class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-2 rounded-lg mr-3">
            <i class="fas fa-chart-bar"></i>
        </span>
        Reportes y Análisis
    </h1>
    <p class="text-sm text-gray-600">Visualiza las estadísticas y métricas de tus contratos</p>
</div>

<!-- Tarjetas de resumen principales -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
    <!-- Total Contratos -->
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg overflow-hidden">
        <div class="p-5 text-white">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold uppercase tracking-wider opacity-90">Total Contratos</h5>
                <i class="fas fa-file-contract text-2xl opacity-75"></i>
            </div>
            <h2 class="text-4xl font-bold mb-1">@ViewBag.TotalContratos</h2>
            <p class="text-xs opacity-75">@ViewBag.ContratosActivos activos</p>
        </div>
    </div>
    
    <!-- Valor Total -->
    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg overflow-hidden">
        <div class="p-5 text-white">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold uppercase tracking-wider opacity-90">Valor Total</h5>
                <i class="fas fa-dollar-sign text-2xl opacity-75"></i>
            </div>
            <h2 class="text-3xl font-bold mb-1">@(((decimal)ViewBag.ValorTotalPesos).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h2>
            <p class="text-xs opacity-75">En todos los contratos</p>
        </div>
    </div>
    
    <!-- Por Vencer -->
    <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl shadow-lg overflow-hidden">
        <div class="p-5 text-white">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold uppercase tracking-wider opacity-90">Por Vencer</h5>
                <i class="fas fa-clock text-2xl opacity-75"></i>
            </div>
            <h2 class="text-4xl font-bold mb-1">@ViewBag.ContratosPorVencer</h2>
            <p class="text-xs opacity-75">En los próximos 30 días</p>
        </div>
    </div>
    
    <!-- Vencidos -->
    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg overflow-hidden">
        <div class="p-5 text-white">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold uppercase tracking-wider opacity-90">Vencidos</h5>
                <i class="fas fa-exclamation-triangle text-2xl opacity-75"></i>
            </div>
            <h2 class="text-4xl font-bold mb-1">@ViewBag.ContratosVencidos</h2>
            <p class="text-xs opacity-75">Requieren atención</p>
        </div>
    </div>
</div>

<!-- Tarjetas financieras -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-6">
    <!-- Facturado -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-5 border-l-4 border-cyan-500">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Facturado</h5>
                <i class="fas fa-check-circle text-cyan-500 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-cyan-600 mb-1">@(((decimal)ViewBag.ValorTotalFacturado).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h2>
            <p class="text-xs text-gray-500">Total ejecutado</p>
        </div>
    </div>
    
    <!-- Pendiente -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-5 border-l-4 border-gray-500">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Pendiente</h5>
                <i class="fas fa-hourglass-half text-gray-500 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-600 mb-1">@(((decimal)ViewBag.ValorTotalPendiente).ToString("C0", new System.Globalization.CultureInfo("es-CO")))</h2>
            <p class="text-xs text-gray-500">Por ejecutar</p>
        </div>
    </div>
    
    <!-- % Ejecución -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-5 border-l-4 border-purple-500">
            <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">% Ejecución</h5>
                <i class="fas fa-percentage text-purple-500 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-purple-600 mb-1">@(((decimal)ViewBag.PromedioEjecucion).ToString("F2"))%</h2>
            <p class="text-xs text-gray-500">Promedio general</p>
        </div>
    </div>
</div>

<!-- Gráficas -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Contratos por Estado -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-blue-500 to-blue-600 border-b border-blue-700">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-chart-pie mr-2"></i>
                Contratos por Estado
            </h3>
        </div>
        <div class="p-6">
            <div id="chartEstados"></div>
        </div>
    </div>
    
    <!-- Contratos por Categoría -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-green-500 to-emerald-600 border-b border-green-700">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-chart-pie mr-2"></i>
                Contratos por Categoría
            </h3>
        </div>
        <div class="p-6">
            <div id="chartCategorias"></div>
        </div>
    </div>
</div>

<!-- Evolución por año -->
<div class="bg-white rounded-xl shadow-md overflow-hidden mb-6">
    <div class="px-5 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 border-b border-purple-700">
        <h3 class="text-lg font-semibold text-white flex items-center">
            <i class="fas fa-chart-line mr-2"></i>
            Evolución de Contratos por Año
        </h3>
    </div>
    <div class="p-6">
        <div id="chartAnios"></div>
    </div>
</div>

<!-- Top 10 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Top Empresas -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 border-b border-yellow-700">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-building mr-2"></i>
                Top 10 Empresas por Valor
            </h3>
        </div>
        <div class="p-6">
            <div id="chartEmpresas"></div>
        </div>
    </div>
    
    <!-- Top Clientes -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="px-5 py-4 bg-gradient-to-r from-red-500 to-red-600 border-b border-red-700">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-users mr-2"></i>
                Top 10 Clientes por Valor
            </h3>
        </div>
        <div class="p-6">
            <div id="chartClientes"></div>
        </div>
    </div>
</div>

<!-- Botones de reportes específicos -->
<div class="flex flex-col sm:flex-row gap-4 justify-center">
    <a asp-action="Clientes" 
       class="inline-flex items-center justify-center px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition">
        <i class="fas fa-users text-2xl mr-3"></i>
        <div class="text-left">
            <div class="text-sm opacity-90">Ver Reporte de</div>
            <div class="text-lg">Clientes</div>
        </div>
    </a>
    <a asp-action="Ejecutivo" 
       class="inline-flex items-center justify-center px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition">
        <i class="fas fa-chart-line text-2xl mr-3"></i>
        <div class="text-left">
            <div class="text-sm opacity-90">Ver Reporte</div>
            <div class="text-lg">Ejecutivo</div>
        </div>
    </a>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <script>
        // Función para formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // ==================== GRÁFICA DE ESTADOS ====================
        var estadosData = @Html.Raw(Json.Serialize(ViewBag.ContratosPorEstado ?? new List<object>()));
        
        if (estadosData && estadosData.length > 0) {
            var optionsEstados = {
                series: estadosData.map(x => x.cantidad),
                chart: {
                    type: 'donut',
                    height: 320,
                    fontFamily: 'Inter, sans-serif',
                },
                labels: estadosData.map(x => x.estado),
                colors: ['#10b981', '#ef4444', '#f59e0b', '#6b7280', '#3b82f6'],
                legend: {
                    position: 'bottom',
                    fontSize: '14px'
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return Math.round(val) + '%';
                    }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '65%',
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total',
                                    fontSize: '18px',
                                    fontWeight: 600
                                }
                            }
                        }
                    }
                }
            };
            var chartEstados = new ApexCharts(document.querySelector("#chartEstados"), optionsEstados);
            chartEstados.render();
        } else {
            document.querySelector("#chartEstados").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-chart-pie text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }

        // ==================== GRÁFICA DE CATEGORÍAS ====================
        var categoriasData = @Html.Raw(Json.Serialize(ViewBag.ContratosPorCategoria ?? new List<object>()));
        
        if (categoriasData && categoriasData.length > 0) {
            var optionsCategorias = {
                series: categoriasData.map(x => x.cantidad),
                chart: {
                    type: 'pie',
                    height: 320,
                    fontFamily: 'Inter, sans-serif',
                },
                labels: categoriasData.map(x => x.categoria),
                colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6', '#ec4899', '#f97316'],
                legend: {
                    position: 'bottom',
                    fontSize: '14px'
                },
                dataLabels: {
                    enabled: true
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            height: 300
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };
            var chartCategorias = new ApexCharts(document.querySelector("#chartCategorias"), optionsCategorias);
            chartCategorias.render();
        } else {
            document.querySelector("#chartCategorias").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-chart-pie text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }

        // ==================== GRÁFICA DE AÑOS ====================
        var aniosData = @Html.Raw(Json.Serialize(ViewBag.ContratosPorAnio ?? new List<object>()));
        
        if (aniosData && aniosData.length > 0) {
            var optionsAnios = {
                series: [{
                    name: 'Cantidad de Contratos',
                    type: 'column',
                    data: aniosData.map(x => x.cantidad)
                }, {
                    name: 'Valor (Millones COP)',
                    type: 'line',
                    data: aniosData.map(x => Math.round(x.valor / 1000000))
                }],
                chart: {
                    height: 350,
                    type: 'line',
                    fontFamily: 'Inter, sans-serif',
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            zoom: true
                        }
                    }
                },
                stroke: {
                    width: [0, 4],
                    curve: 'smooth'
                },
                dataLabels: {
                    enabled: true,
                    enabledOnSeries: [1]
                },
                labels: aniosData.map(x => x.anio.toString()),
                xaxis: {
                    title: {
                        text: 'Año'
                    }
                },
                yaxis: [{
                    title: {
                        text: 'Cantidad de Contratos',
                    },
                }, {
                    opposite: true,
                    title: {
                        text: 'Valor (Millones COP)'
                    }
                }],
                colors: ['#3b82f6', '#10b981'],
                legend: {
                    position: 'top'
                }
            };
            var chartAnios = new ApexCharts(document.querySelector("#chartAnios"), optionsAnios);
            chartAnios.render();
        } else {
            document.querySelector("#chartAnios").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-chart-line text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }

        // ==================== GRÁFICA DE EMPRESAS ====================
        var empresasData = @Html.Raw(Json.Serialize(ViewBag.ContratosPorEmpresa ?? new List<object>()));
        
        if (empresasData && empresasData.length > 0) {
            var optionsEmpresas = {
                series: [{
                    name: 'Valor (Millones COP)',
                    data: empresasData.map(x => Math.round(x.valor / 1000000))
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    fontFamily: 'Inter, sans-serif',
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        horizontal: true,
                        distributed: true,
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                colors: ['#f59e0b', '#fb923c', '#fdba74', '#fed7aa', '#ffedd5'],
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return '$' + val + 'M';
                    },
                    offsetX: 30,
                    style: {
                        fontSize: '12px',
                        colors: ['#333']
                    }
                },
                xaxis: {
                    categories: empresasData.map(x => x.empresa),
                    title: {
                        text: 'Valor (Millones COP)'
                    }
                },
                legend: {
                    show: false
                }
            };
            var chartEmpresas = new ApexCharts(document.querySelector("#chartEmpresas"), optionsEmpresas);
            chartEmpresas.render();
        } else {
            document.querySelector("#chartEmpresas").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-building text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }

        // ==================== GRÁFICA DE CLIENTES ====================
        var clientesData = @Html.Raw(Json.Serialize(ViewBag.TopClientes ?? new List<object>()));
        
        if (clientesData && clientesData.length > 0) {
            var optionsClientes = {
                series: [{
                    name: 'Valor (Millones COP)',
                    data: clientesData.map(x => Math.round(x.valor / 1000000))
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    fontFamily: 'Inter, sans-serif',
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        horizontal: true,
                        distributed: true,
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                colors: ['#ef4444', '#f87171', '#fca5a5', '#fecaca', '#fee2e2'],
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return '$' + val + 'M';
                    },
                    offsetX: 30,
                    style: {
                        fontSize: '12px',
                        colors: ['#333']
                    }
                },
                xaxis: {
                    categories: clientesData.map(x => x.cliente),
                    title: {
                        text: 'Valor (Millones COP)'
                    }
                },
                legend: {
                    show: false
                }
            };
            var chartClientes = new ApexCharts(document.querySelector("#chartClientes"), optionsClientes);
            chartClientes.render();
        } else {
            document.querySelector("#chartClientes").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-users text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }
    </script>
}
