@{
    ViewData["Title"] = "Reportes y Análisis";
}

<!-- Header -->
<div class="mb-6">
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="h-2 bg-gradient-to-r from-[#0c1791] to-[#0ff2f2]"></div>
        <div class="px-6 py-5">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center mb-2">
                <i class="fas fa-chart-bar text-[#0c1791] mr-3"></i>
                Reportes y Análisis
            </h1>
            <p class="text-sm text-gray-600">Visualiza las estadísticas y métricas de tus contratos</p>
        </div>
    </div>
</div>

<!-- Tarjetas de resumen principales -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
    <!-- Total Contratos -->
    <div class="bg-gradient-to-br from-white to-[#f6fbff] border border-[#0c1791]/12 rounded-xl shadow-sm p-4 hover:shadow-md hover:border-[#0c1791]/30 transition">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-[#0c1791]/10 text-[#0c1791] flex items-center justify-center border border-[#0c1791]/20">
                    <i class="fas fa-file-contract text-base"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Total Contratos</p>
                    <p class="text-2xl font-semibold text-gray-900">@ViewBag.TotalContratos</p>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-600 mt-2">@ViewBag.ContratosActivos activos</p>
    </div>
    
    <!-- Valor Total -->
    <div class="bg-gradient-to-br from-white to-[#f6fbff] border-l-4 border-[#0c1791] rounded-xl shadow-sm p-4 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-[#0c1791]/10 text-[#0c1791] flex items-center justify-center">
                    <i class="fas fa-dollar-sign text-base"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Valor Total</p>
                    <h2 class="text-2xl font-semibold text-gray-900">
                        @(((decimal)ViewBag.ValorTotalPesos).ToString("C0", new System.Globalization.CultureInfo("es-CO")))
                    </h2>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-600">En todos los contratos</p>
    </div>
    
    <!-- Por Vencer -->
    <div class="bg-gradient-to-br from-white to-[#f6fbff] border border-[#0c1791]/12 rounded-xl shadow-sm p-4 hover:shadow-md hover:border-[#0c1791]/30 transition">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-[#0ff2f2]/12 text-[#0c1791] flex items-center justify-center border border-[#0ff2f2]/40">
                    <i class="fas fa-clock text-base"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Por Vencer</p>
                    <p class="text-2xl font-semibold text-gray-900">@ViewBag.ContratosPorVencer</p>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-600 mt-2">En los próximos 30 días</p>
    </div>
    
    <!-- Vencidos -->
    <div class="bg-gradient-to-br from-white to-[#f6fbff] border border-[#0c1791]/12 rounded-xl shadow-sm p-4 hover:shadow-md hover:border-[#0c1791]/30 transition">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-[#0ff2f2]/12 text-[#0c1791] flex items-center justify-center border border-[#0ff2f2]/40">
                    <i class="fas fa-exclamation-triangle text-base"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Vencidos</p>
                    <p class="text-2xl font-semibold text-gray-900">@ViewBag.ContratosVencidos</p>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-600 mt-2">Requieren atención</p>
    </div>
</div>

<!-- Tarjetas financieras -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-6">
    <!-- Facturado -->
    <div class="bg-gradient-to-br from-white to-[#f6fbff] border-l-4 border-[#0c1791] rounded-xl shadow-sm p-4 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-[#0c1791]/10 text-[#0c1791] flex items-center justify-center">
                    <i class="fas fa-check-circle text-base"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Facturado</p>
                    <h2 class="text-2xl font-semibold text-gray-900">
                        @(((decimal)ViewBag.ValorTotalFacturado).ToString("C0", new System.Globalization.CultureInfo("es-CO")))
                    </h2>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-600">Total ejecutado</p>
    </div>
    
    <!-- Pendiente -->
    <div class="bg-gradient-to-br from-white to-[#f6fbff] border-l-4 border-[#0ff2f2] rounded-xl shadow-sm p-4 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-[#0ff2f2]/10 text-[#0c1791] flex items-center justify-center">
                    <i class="fas fa-hourglass-half text-base"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Pendiente</p>
                    <h2 class="text-2xl font-semibold text-gray-900">
                        @(((decimal)ViewBag.ValorTotalPendiente).ToString("C0", new System.Globalization.CultureInfo("es-CO")))
                    </h2>
                </div>
            </div>
        </div>
        <p class="text-xs text-gray-600">Por ejecutar</p>
    </div>
    
    <!-- % Ejecución -->
    <div class="bg-gradient-to-br from-white to-[#f6fbff] border border-[#0c1791]/12 rounded-xl shadow-sm p-4 hover:shadow-md transition">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-gray-50 text-gray-700 flex items-center justify-center border border-gray-200">
                    <i class="fas fa-chart-line text-base"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Ejecución</p>
                    <h2 class="text-2xl font-semibold text-gray-900">
                        @(((decimal)ViewBag.PromedioEjecucion).ToString("F1"))%
                    </h2>
                </div>
            </div>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-1.5">
            <div class="bg-gradient-to-r from-[#0c1791] to-[#0ff2f2] h-1.5 rounded-full transition-all" style="width: @(((decimal)ViewBag.PromedioEjecucion).ToString("F0"))%"></div>
        </div>
    </div>
</div>

<!-- Gráficas -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Contratos por Estado -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-5 py-3 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-[#f6fbff]">
            <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                <i class="fas fa-chart-pie text-[#0c1791]"></i>
                Contratos por Estado
            </h3>
        </div>
        <div class="p-6">
            <div id="chartEstados"></div>
        </div>
    </div>
    
    <!-- Contratos por Categoría -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-5 py-3 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-[#f6fbff]">
            <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                <i class="fas fa-chart-pie text-[#0c1791]"></i>
                Contratos por Categoría
            </h3>
        </div>
        <div class="p-6">
            <div id="chartCategorias"></div>
        </div>
    </div>
</div>

<!-- Evolución por año -->
<div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden mb-6">
    <div class="px-5 py-3 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-[#f6fbff]">
        <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">
            <i class="fas fa-chart-line text-[#0c1791]"></i>
            Evolución de Contratos por Año
        </h3>
    </div>
    <div class="p-6">
        <div id="chartAnios"></div>
    </div>
</div>

<!-- Top 10 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Top Empresas -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-5 py-3 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-[#f6fbff]">
            <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                <i class="fas fa-building text-[#0c1791]"></i>
                Top 10 Empresas por Valor
            </h3>
        </div>
        <div class="p-6">
            <div id="chartEmpresas"></div>
        </div>
    </div>
    
    <!-- Top Clientes -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="px-5 py-3 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-[#f6fbff]">
            <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                <i class="fas fa-users text-[#0c1791]"></i>
                Top 10 Clientes por Valor
            </h3>
        </div>
        <div class="p-6">
            <div id="chartClientes"></div>
        </div>
    </div>
</div>

<!-- Botones de reportes específicos -->
<div class="flex flex-col sm:flex-row gap-4 justify-center">
    <a asp-action="Clientes" 
       class="flex items-center gap-3 px-4 py-3 bg-[#0c1791] text-white rounded-lg shadow-sm hover:shadow-md hover:bg-[#0a1478] transition">
        <i class="fas fa-users text-xl"></i>
        <span class="font-semibold text-sm">Ver Reporte de Clientes</span>
    </a>
    <a asp-action="Ejecutivo" 
       class="flex items-center gap-3 px-4 py-3 bg-white border border-gray-200 text-gray-700 rounded-lg shadow-sm hover:shadow-md hover:border-[#0c1791] hover:text-[#0c1791] transition">
        <i class="fas fa-chart-line text-xl"></i>
        <span class="font-semibold text-sm">Ver Reporte Ejecutivo</span>
    </a>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <script>
        // Función para formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // ==================== GRÁFICA DE ESTADOS ====================
        var estadosData = @Html.Raw(Json.Serialize(ViewBag.ContratosPorEstado ?? new List<object>()));
        
        if (estadosData && estadosData.length > 0) {
            var optionsEstados = {
                series: estadosData.map(x => x.cantidad),
                chart: {
                    type: 'donut',
                    height: 320,
                    fontFamily: 'Inter, sans-serif',
                },
                labels: estadosData.map(x => x.estado),
                colors: ['#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#3b82f6', '#ec4899', '#06b6d4', '#f97316'],
                legend: {
                    position: 'bottom',
                    fontSize: '14px'
                },
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return Math.round(val) + '%';
                    }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '65%',
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total',
                                    fontSize: '18px',
                                    fontWeight: 600
                                }
                            }
                        }
                    }
                }
            };
            var chartEstados = new ApexCharts(document.querySelector("#chartEstados"), optionsEstados);
            chartEstados.render();
        } else {
            document.querySelector("#chartEstados").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-chart-pie text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }

        // ==================== GRÁFICA DE CATEGORÍAS ====================
        var categoriasData = @Html.Raw(Json.Serialize(ViewBag.ContratosPorCategoria ?? new List<object>()));
        
        if (categoriasData && categoriasData.length > 0) {
            var optionsCategorias = {
                series: categoriasData.map(x => x.cantidad),
                chart: {
                    type: 'pie',
                    height: 320,
                    fontFamily: 'Inter, sans-serif',
                },
                labels: categoriasData.map(x => x.categoria),
                colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6', '#ec4899', '#f97316', '#14b8a6', '#a855f7', '#f43f5e', '#fb7185'],
                legend: {
                    position: 'bottom',
                    fontSize: '14px'
                },
                dataLabels: {
                    enabled: true
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            height: 300
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };
            var chartCategorias = new ApexCharts(document.querySelector("#chartCategorias"), optionsCategorias);
            chartCategorias.render();
        } else {
            document.querySelector("#chartCategorias").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-chart-pie text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }

        // ==================== GRÁFICA DE AÑOS ====================
        var aniosData = @Html.Raw(Json.Serialize(ViewBag.ContratosPorAnio ?? new List<object>()));
        
        if (aniosData && aniosData.length > 0) {
            var optionsAnios = {
                series: [{
                    name: 'Cantidad de Contratos',
                    type: 'column',
                    data: aniosData.map(x => x.cantidad)
                }, {
                    name: 'Valor (Millones COP)',
                    type: 'line',
                    data: aniosData.map(x => Math.round(x.valor / 1000000))
                }],
                chart: {
                    height: 350,
                    type: 'line',
                    fontFamily: 'Inter, sans-serif',
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            zoom: true
                        }
                    }
                },
                stroke: {
                    width: [0, 4],
                    curve: 'smooth'
                },
                dataLabels: {
                    enabled: true,
                    enabledOnSeries: [1]
                },
                labels: aniosData.map(x => x.anio.toString()),
                xaxis: {
                    title: {
                        text: 'Año'
                    }
                },
                yaxis: [{
                    title: {
                        text: 'Cantidad de Contratos',
                    },
                }, {
                    opposite: true,
                    title: {
                        text: 'Valor (Millones COP)'
                    }
                }],
                colors: ['#3b82f6', '#10b981', '#8b5cf6', '#ec4899'],
                legend: {
                    position: 'top'
                }
            };
            var chartAnios = new ApexCharts(document.querySelector("#chartAnios"), optionsAnios);
            chartAnios.render();
        } else {
            document.querySelector("#chartAnios").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-chart-line text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }

        // ==================== GRÁFICA DE EMPRESAS ====================
        var empresasData = @Html.Raw(Json.Serialize(ViewBag.ContratosPorEmpresa ?? new List<object>()));
        
        if (empresasData && empresasData.length > 0) {
            var optionsEmpresas = {
                series: [{
                    name: 'Valor (Millones COP)',
                    data: empresasData.map(x => Math.round(x.valor / 1000000))
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    fontFamily: 'Inter, sans-serif',
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        horizontal: true,
                        distributed: true,
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                colors: ['#f59e0b', '#fb923c', '#f97316', '#ea580c', '#c2410c', '#9a3412', '#7c2d12', '#78350f', '#713f12', '#6b3410'],
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return '$' + val + 'M';
                    },
                    offsetX: 30,
                    style: {
                        fontSize: '12px',
                        colors: ['#333']
                    }
                },
                xaxis: {
                    categories: empresasData.map(x => x.empresa),
                    title: {
                        text: 'Valor (Millones COP)'
                    }
                },
                legend: {
                    show: false
                }
            };
            var chartEmpresas = new ApexCharts(document.querySelector("#chartEmpresas"), optionsEmpresas);
            chartEmpresas.render();
        } else {
            document.querySelector("#chartEmpresas").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-building text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }

        // ==================== GRÁFICA DE CLIENTES ====================
        var clientesData = @Html.Raw(Json.Serialize(ViewBag.TopClientes ?? new List<object>()));
        
        if (clientesData && clientesData.length > 0) {
            var optionsClientes = {
                series: [{
                    name: 'Valor (Millones COP)',
                    data: clientesData.map(x => Math.round(x.valor / 1000000))
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    fontFamily: 'Inter, sans-serif',
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        horizontal: true,
                        distributed: true,
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                colors: ['#ef4444', '#f87171', '#f43f5e', '#e11d48', '#be123c', '#9f1239', '#881337', '#7f1d1d', '#7c2d12', '#6b1f1f'],
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return '$' + val + 'M';
                    },
                    offsetX: 30,
                    style: {
                        fontSize: '12px',
                        colors: ['#333']
                    }
                },
                xaxis: {
                    categories: clientesData.map(x => x.cliente),
                    title: {
                        text: 'Valor (Millones COP)'
                    }
                },
                legend: {
                    show: false
                }
            };
            var chartClientes = new ApexCharts(document.querySelector("#chartClientes"), optionsClientes);
            chartClientes.render();
        } else {
            document.querySelector("#chartClientes").innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-users text-5xl mb-3"></i><p>No hay datos disponibles</p></div>';
        }
    </script>
}
